# Data Model: 都道府県コード変換・住所逆引き

**Branch**: `004-prefecture-code-reverse-lookup`  
**Date**: 2026-02-23

---

## 概要

本機能では **新規の DB テーブルは追加しない**。都道府県コード⇔名称はメモリ内の定数、逆引きは既存の `jp_address_complement_postal_codes` テーブルを利用する。

---

## 1. 都道府県マッピング（論理エンティティ）

コード⇔名称の対応は、gem 内の静的なデータとして保持する。

### 属性

| 属性 | 型 | 説明 |
|------|-----|------|
| コード | String (2桁) | JIS X 0401。01–47。ゼロパディング（"01", "13"）。 |
| 名称 | String | 都道府県名（正式名称）。例: "東京都", "北海道"。 |

### 制約

- コードは 01–47 の範囲のみ有効。それ以外は該当なしとして nil を返す。
- 名称は正式名称のみ有効。省略表記は受け付けない（該当なし → nil）。
- 入力が nil または空文字の場合は例外を投げず nil を返す。

### 実装上の表現

- Ruby ではハッシュ 2 つ、または 1 つのハッシュで双方向参照可能にする。
  - 例: `CODE_TO_NAME = { "01" => "北海道", ... }` と `NAME_TO_CODE = CODE_TO_NAME.invert`（または 47 件の定数マッピング）。

---

## 2. 逆引き入力（Reverse Lookup Input）

API の引数として渡す構造。DB の形ではなく、メソッドのキーワード引数として表現する。

### フィールド

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| pref | String | ✅ | 都道府県名（正式名称）。住所データの `pref` と完全一致。 |
| city | String | ✅ | 市区町村名。住所データの `city` と完全一致。 |
| town | String | ❌ | 町域名。省略時は都道府県＋市区町村のみで検索。指定時は `town` と完全一致で絞り込む。 |

### 検索条件

- pref と city が両方揃っている場合のみ検索を実行する。
- 各フィールドは既存の `jp_address_complement_postal_codes` の `pref`, `city`, `town` と **完全一致** で照合する。
- 入力は UTF-8。住所データ（郵便番号データ）と同じ表記を前提とする。

---

## 3. 逆引き結果（郵便番号候補）

逆引きの戻り値は **郵便番号（7桁文字列）の配列**。

### 制約

- 該当する郵便番号を重複なく返す。同一郵便番号に複数レコード（町域違い等）がある場合は 1 つにまとめる。
- 該当なし・入力不十分（pref または city が空など）の場合は空配列 `[]` を返す。
- 不正入力時も例外を投げず `[]` を返す。

---

## 4. 既存テーブルとの関係

既存の `jp_address_complement_postal_codes` のカラム `pref_code`, `pref`, `city`, `town` をそのまま利用する。

### 逆引き用のインデックス（推奨）

パフォーマンス要件（SC-003: 50ms p99）を満たすため、次の複合インデックスの追加を推奨する。

- カラム: `(pref, city, town)` または `(pref_code, city, town)`
- 用途: `WHERE pref = ? AND city = ? AND (town = ? OR town IS NULL)` のような逆引きクエリの高速化

既存の 001 マイグレーションを変更しない方針とする場合は、別マイグレーションまたはドキュメント上の「推奨インデックス」として案内する。
