# Research: CSVインポート時の消えたレコード削除

**Branch**: `003-csv-remove-obsolete`  
**Date**: 2025-02-23

---

## 1. 削除の実行タイミング（二相インポート）

**Decision**: upsert を全て成功させた後にのみ削除フェーズを実行する。

**Rationale**:
- 仕様 Clarification で「削除は upsert 完了後に実施」を採用済み。
- upsert 途中で失敗した場合、削除を一切行わないため、既存データが中途半端に消えない。
- 再実行で同じCSVを流せば整合する。単一トランザクションで全体を囲むより実装が単純で、既存のバッチ upsert の戻り値（成功/失敗）をそのまま利用できる。

**Alternatives considered**:
- 単一トランザクションで upsert + delete: メモリ上に「今回のCSVの全キー」を保持する必要があり、トランザクション時間が長くなる。本 gem のスコープでは二相で十分。
- 削除を先に実行: 削除後に upsert が失敗すると「消えたまま」の不整合が残る。仕様で拒否済み。

---

## 2. 「消えたレコード」の検出方法

**Decision**: 今回のCSVを1回走査する間に「出現した一意キー」の集合をメモリ（Set）で保持し、upsert 完了後に「その集合に含まれない」テーブル行を削除する。

**Rationale**:
- 既存の一意キー `(postal_code, pref_code, city, town)` は Constitution および既存コードで固定。同じキーで upsert しているため、「今回CSVに1行も出てこなかったキー」＝削除対象。
- KEN_ALL は約12万〜14万行。キー4要素の Set はメモリ負荷が許容範囲。
- 二回走査（1回目でキー収集、2回目で upsert）にするとファイル I/O が倍になるため、1回の `CSV.foreach` 内で「キーを Set に追加」と「バッチ upsert」を並行して行う。

**Alternatives considered**:
- 削除フラグ列（`deleted_at`）: スキーマ変更が必要で、本機能スコープは「単一テーブル・既存スキーマのまま」のため不採用。将来の拡張では選択肢になり得る。
- 一時テーブルに載せ替え: Constitution の「全更新」フォールバックで言及されているが、今回は「差分削除」のみで足りるため過剰。

---

## 3. 空CSVの検出と拒否

**Decision**: 有効行が1行もない場合（ヘッダのみや空ファイル）は、upsert を1件も行わず、例外またはエラー終了とする。削除は実行しない。

**Rationale**:
- 仕様で「空CSVは拒否」を採用。誤操作による全削除を防ぐ。
- 実装: 1行目を読む前にファイルが空か、または `CSV.foreach` で1件も `parse_row` が有効なレコードを返さなかった時点で「有効行0件」と判定し、`ImportError`（または既存の `JpAddressComplement::ImportError`）を発生させる。

**Alternatives considered**:
- 空CSVを許可して全削除: 仕様で拒否済み（誤操作リスク）。
- 明示フラグでのみ全削除: 仕様で「空CSVは拒否」を選択済みのため、今回は不要。

---

## 4. 追加・更新・削除件数の報告

**Decision**: インポート処理の戻り値で「追加（新規）・更新・削除」の件数を持ち、Rake タスクから標準出力で報告する。

**Rationale**:
- 仕様 FR-006 で「利用者が確認できる形で報告」を要求。Rake タスクは標準出力が自然。
- upsert_all は「insert されたか update されたか」を DB によっては返せるが、汎用的にするため「今回CSVの行数」と「削除した行数」を明示的に数える方が確実。追加/更新の内訳は、実装コストと価値のバランスで「upsert した行数（新規+更新の合計）」と「削除した行数」の2種類でも可。必要なら「挿入件数」「更新件数」を DB の戻り値で分離する（PostgreSQL の upsert 戻り値等）。

**Alternatives considered**:
- 報告しない: 仕様で「件数を報告する」を採用済みのため不採用。
- ログのみ: 運用では標準出力の方が Rake 実行結果として見やすいため、標準出力を主とし、必要に応じてログも出す。

---

## 5. 一意キーの扱い（既存準拠）

**Decision**: 一意キーは既存の `unique_by: %i[postal_code pref_code city town]` を変更しない。削除対象の判定も同じ4要素の組み合わせで行う。

**Rationale**:
- 001 の data-model および既存 CsvImporter で確定済み。本機能は「削除」を足すだけで、キー定義の変更は不要。
