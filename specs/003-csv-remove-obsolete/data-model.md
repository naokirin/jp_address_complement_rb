# Data Model: 003 CSVインポート時の消えたレコード削除

**Branch**: `003-csv-remove-obsolete`  
**Date**: 2025-02-23

---

## 既存エンティティ（変更なし）

- **住所レコード（PostalCode / jp_address_complement_postal_codes）**: 001 の data-model に準拠。一意キーは `(postal_code, pref_code, city, town)`。
- **AddressRecord**: 検索結果の値オブジェクト。本機能では変更なし。

---

## 本機能で扱うデータ

### 1. インポート中に保持する「今回CSVに出現したキー集合」

- **役割**: 削除フェーズで「この集合に含まれない行」をストアから削除するための判定に使う。
- **表現**: 一意キー4要素の組み合わせの集合。実装では `Set<[postal_code, pref_code, city, town]>` または同等（例: `Set<String>` でキーを文字列化したもの）。
- **ライフサイクル**: 1回の `import` 呼び出しの開始時に空で初期化し、CSV の有効行を処理するたびに追加。upsert 完了後に削除クエリの条件に使用し、メソッド終了後は破棄。
- **永続化**: しない（メモリのみ）。

### 2. インポート結果（件数報告用）

- **役割**: FR-006 に基づき、追加・更新・削除の件数を利用者に報告する。
- **表現**: 次のいずれかで十分。
  - **案A**: `{ inserted: Integer, updated: Integer, deleted: Integer }` のようにハッシュまたは Data オブジェクト。
  - **案B**: `{ upserted: Integer, deleted: Integer }` のように「upsert した総数」と「削除した数」の2つ（DB が insert/update を区別して返さない場合はこちらが簡易）。
- **取得方法**: `CsvImporter#import` の戻り値。Rake タスクはこの戻り値を標準出力に整形して表示する。
- **永続化**: しない。ログに残すかは実装オプション。

---

## 削除対象の定義（FR-002 準拠）

- テーブル `jp_address_complement_postal_codes` の行のうち、その行の `(postal_code, pref_code, city, town)` が、**今回のCSVを走査して得た「出現したキー集合」に含まれない**ものが削除対象。
- 単一ストア（このテーブルのみ）を対象とし、他テーブル・他ソースは考慮しない。

---

## 状態遷移（インポート1回分）

1. **開始**: キー集合を空で初期化。有効行数カウント 0。
2. **CSV 走査**: 有効行ごとにキーを集合に追加し、バッチ upsert。有効行が 0 件の時点で検出したら空CSVとしてエラー終了（削除・upsert とも行わない）。
3. **Upsert 完了後**: キー集合に含まれない行をテーブルから削除。削除件数を集計。
4. **終了**: 追加（および/または更新）件数と削除件数を返す。
