# Feature Specification: CSVインポート時の消えたレコード削除

**Feature Branch**: `003-csv-remove-obsolete`  
**Created**: 2025-02-23  
**Status**: Draft  
**Input**: User description: "現在のCSVインポートでは、新しいCSVから「消えたレコード」を削除する機能がないため、消えた住所情報が残り続ける問題があります。CSVインポート時になくなった住所情報を削除するようにします"

## Clarifications

### Session 2025-02-23

- Q: インポート途中で失敗した場合、削除と追加・更新の整合性をどう保つか（削除の実行タイミング・トランザクション方針）？ → A: 削除は upsert 完了後に実施。upsert が全て成功した場合のみ削除フェーズを実行する。途中失敗時は削除は行わず、既存データはそのまま。再実行で同じCSVを流して整合を取る。
- Q: 空のCSV（0件）でインポートした場合の扱い（全削除するか・拒否するか）？ → A: 空CSVは拒否。0件のCSVの場合はインポートを実行せずエラーとし、既存データは変更しない。
- Q: 削除対象のスコープ（単一ストアか・複数ソース混在を想定するか）？ → A: 単一ストアに限定。本機能ではインポート対象は KEN_ALL 用の単一ストア（1テーブル）のみ。他ソースの混在は考慮しない。
- Q: インポート完了時に追加・更新・削除件数を利用者に報告するか？ → A: 件数を報告する。インポート完了時に、追加（新規）・更新・削除の件数を利用者が確認できる形で報告する。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - フルインポートで新CSVにない住所レコードを削除する (Priority: P1)

管理者が KEN_ALL.CSV の新版でフルインポートを実行したとき、今回のCSVに含まれない住所レコードがストアから削除され、CSVの内容とストアの内容が一致する。

**Why this priority**: 消えたレコードが残り続ける現状の問題を解消する本機能の根幹である。

**Independent Test**: 既存データがある状態で、一部レコードを除いたCSVでインポートを実行し、除いたレコードがストアから消えていることを確認する。

**Acceptance Scenarios**:

1. **Given** ストアに住所レコード A, B, C が存在する, **When** レコード B を含まない新しいCSVでインポートを実行する, **Then** インポート完了後、ストアに A と C のみが残り、B は削除されている
2. **Given** ストアが空である, **When** 任意のCSVでインポートを実行する, **Then** 削除対象はなく、CSVの内容のみが登録される
3. **Given** ストアに住所レコードが存在する, **When** 同じ内容のCSVで再度インポートを実行する, **Then** 既存レコードは維持され、新CSVにないレコードがなければ削除は発生しない（冪等）

---

### User Story 2 - 削除と追加・更新が同一インポートで正しく反映される (Priority: P2)

管理者が、前回よりレコードが増減・変更されたCSVでインポートしたとき、追加・更新・削除が一括で正しく反映される。

**Why this priority**: 実運用では「消えたものの削除」と「新規・更新」を同時に扱うため、同一インポート内で一貫して動作することが必要である。

**Independent Test**: 既存データに対し、一部削除・一部追加・一部変更したCSVでインポートし、最終状態がCSVと一致することを確認する。

**Acceptance Scenarios**:

1. **Given** ストアにレコード A, B が存在する, **When** A を削除し C を追加したCSVでインポートする, **Then** 完了後は B と C が存在し、A は存在しない
2. **Given** ストアにレコードが存在する, **When** 同じ一意キーで内容が変更されたCSVでインポートする, **Then** 該当レコードは更新され、かつ新CSVにない他レコードは削除される

---

### Edge Cases

- 新CSVが空（0件）の場合：インポートを拒否し、エラーとして終了する。既存の住所レコードは変更しない（誤操作による全削除を防ぐ）。
- インポート途中で失敗した場合：削除は upsert が全て成功した後にのみ実行する。upsert の途中で失敗した場合は削除フェーズは行わず、既存データは変更しない。利用者は同じCSVを再実行することで整合性を取る。
- 一意キー（郵便番号・都道府県コード・市区町村・町域など）で「消えた」とみなす基準をどうするか：今回のCSV形式（KEN_ALL.CSV）では、同一キーで upsert しているため、「今回のCSVに出現しなかったキーの組み合わせ」を削除対象とする。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、CSVインポート実行時に、今回読み込んだCSVに存在しない住所レコードをストアから削除しなければならない。
- **FR-002**: 「存在しない」の判定は、既存の一意キー（郵便番号・都道府県コード・市区町村・町域等、既存仕様に準拠）で今回のCSVに一度も出現しなかったレコードとする。
- **FR-003**: 削除は、インポート処理の一環として実行され、同一のインポート操作で「追加・更新」と「削除」の結果が利用者からは一貫して見えなければならない。
- **FR-004**: 空のCSV（有効行が0件）の場合はインポートを実行せず、エラーとし、既存データは変更してはならない。
- **FR-005**: 削除フェーズは、今回のCSVに対する upsert が全て成功した後にのみ実行しなければならない。upsert の途中で失敗した場合は削除を実行せず、既存データは変更しない。利用者が同じCSVを再実行すれば整合した状態になる設計とすること。
- **FR-006**: インポート完了時に、追加（新規）・更新・削除の件数を利用者が確認できる形で報告しなければならない。

### Key Entities

- **住所レコード（郵便番号住所）**: 郵便番号・都道府県・市区町村・町域等の属性を持ち、一意キーで識別される。CSVの1行と1対1対応する。
- **インポート実行**: 1回のCSV読み込みと、それに基づく「追加・更新」および「新CSVにないレコードの削除」の一連の処理。

## Assumptions

- 既存のCSVインポートは KEN_ALL.CSV 形式を前提としており、本機能も同じ形式・同じ一意キーを前提とする。
- 「今回のCSV」は単一ファイルのフル内容を指し、差分だけを渡す部分インポートは対象外とする。
- 本機能のスコープは、KEN_ALL.CSV が投入される単一のストア（1テーブル）に限定する。他ソースの混在は考慮しない。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者が新版CSVでフルインポートを実行した後、ストアに存在する住所レコードの集合が、そのCSVの内容と一致する（新CSVにないレコードが残らない）。
- **SC-002**: 同じCSVで複数回インポートを実行しても結果は同じであり、不要な削除・二重削除が発生しない（冪等）。
- **SC-003**: インポート処理の所要時間やリソースは、既存の追加・更新に加えて削除が入っても、許容可能な範囲に収まる（例: 既存インポート時間の2倍以内など、運用で許容できる目安を満たす）。
