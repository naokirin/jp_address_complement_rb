# Feature Specification: 日本住所補完 Gem

**Feature Branch**: `001-jp-address-complement-gem`  
**Created**: 2026-02-22  
**Status**: Draft  
**Input**: User description: "日本国内の住所を郵便番号や住所の一部から補完できるRails 7.x以上向けのgemを作ります"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 郵便番号から住所を取得する (Priority: P1)

Rails アプリ開発者が郵便番号（7桁）を入力すると、対応する都道府県・市区町村・町域名を取得できる。
フォームの住所欄を自動補完したり、入力済み郵便番号と住所の整合性を確認するために使用する。

**Why this priority**: 住所補完の最も基本的な利用パターンであり、この機能だけで即時に利用価値がある。

**Independent Test**: `JpAddressComplement.search_by_postal_code("1000001")` を呼び出し、千代田区千代田の住所データが返ることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 有効な7桁郵便番号（例: "1000001"）を与えた時、**When** 住所検索を実行すると、**Then** 都道府県・市区町村・町域名を含む住所オブジェクトが返る。
2. **Given** ハイフンあり郵便番号（例: "100-0001"）を与えた時、**When** 住所検索を実行すると、**Then** ハイフンを除去して検索し、正しい住所が返る。
3. **Given** 存在しない郵便番号を与えた時、**When** 住所検索を実行すると、**Then** 空の結果（nilまたは空配列）が返る。
4. **Given** 郵便番号のフォーマットが不正（桁数不足・数字以外含む）の時、**When** 住所検索を実行すると、**Then** エラーを発生させずに空の結果が返る。

---

### User Story 2 - 郵便番号の先頭数字から候補住所を取得する (Priority: P2)

Rails アプリ開発者が郵便番号の先頭4桁以上を入力すると、該当する住所候補の一覧を取得できる。
ユーザーが郵便番号を入力中にリアルタイムでサジェストを表示するために使用する。

**Why this priority**: インクリメンタルサーチによる補完UXを実現するために必要であり、P1の検索機能をベースに拡張できる。

**Independent Test**: `JpAddressComplement.search_by_postal_code_prefix("1000")` を呼び出し、"1000" で始まる複数の住所候補が返ることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 先頭4桁以上の郵便番号（例: "1000"）を与えた時、**When** 候補検索を実行すると、**Then** その番号から始まる複数の住所候補リストが返る。
2. **Given** 先頭4桁未満の文字列（例: "10"）を与えた時、**When** 候補検索を実行すると、**Then** 空の結果が返る（候補が多すぎるため最低桁数制限）。
3. **Given** 7桁の完全な郵便番号を与えた時、**When** 候補検索を実行すると、**Then** 対応する住所のみ（1件または0件）が返る。

---

### User Story 3 - 郵便番号と住所の整合性を検証する (Priority: P3)

Rails アプリ開発者が郵便番号と住所文字列のペアを渡すと、それらが整合しているかどうかを検証できる。
入力フォームのバリデーションやデータクレンジングに使用する。

**Why this priority**: 単体の住所補完よりも活用ケースは限定されるが、データ品質担保の観点で重要な機能。

**Independent Test**: `JpAddressComplement.valid_combination?("1000001", "東京都千代田区千代田")` を呼び出し、`true` が返ることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 正しい郵便番号と対応する住所（一部一致）を与えた時、**When** 整合性検証を実行すると、**Then** `true` が返る。
2. **Given** 郵便番号に対応しない住所を与えた時、**When** 整合性検証を実行すると、**Then** `false` が返る。
3. **Given** 存在しない郵便番号を与えた時、**When** 整合性検証を実行すると、**Then** `false` が返る。

---

### User Story 4 - Rails モデルでバリデーションを使用する (Priority: P4)

Rails アプリ開発者が ActiveRecord モデルに1行のバリデーション宣言を追加するだけで、郵便番号と住所フィールドの整合性チェックを自動化できる。

**Why this priority**: Rails エコシステムへの統合を提供し、日常的な開発ワークフローに組み込みやすくする。

**Independent Test**: `validates :postal_code, jp_address_complement: { address_field: :address }` を記述したモデルをテストし、不整合データのバリデーション失敗を確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** Rails モデルに住所バリデーターを設定し、整合する郵便番号と住所を持つレコードを与えた時、**When** バリデーションを実行すると、**Then** バリデーションが通過する。
2. **Given** Rails モデルに住所バリデーターを設定し、不整合な郵便番号と住所を持つレコードを与えた時、**When** バリデーションを実行すると、**Then** バリデーションが失敗し、エラーメッセージが付与される。
3. **Given** Rails モデルに住所バリデーターを設定し、郵便番号フィールドが空のレコードを与えた時、**When** バリデーションを実行すると、**Then** 住所補完バリデーターはスキップされる（他のバリデーターに委ねる）。

---

### Edge Cases

- 郵便番号が全角数字で入力された場合はどうなるか？（半角変換して処理する）
- 同一郵便番号に複数の町域が対応する場合（大口事業所専用番号など）は全件返す。
- データが存在しない過去・廃止された郵便番号を与えた場合は空を返す。
- 住所文字列に読みがなや英数字が混在する場合でも、漢字表記部分で照合する。
- データファイルが破損・欠損している場合は明確なエラーを発生させる。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Gem は郵便番号（7桁、数字のみ）から都道府県・市区町村・町域名を含む住所データを返せなければならない。
- **FR-002**: Gem はハイフン（"〒100-0001" 形式）を含む郵便番号を自動で正規化（除去）して処理しなければならない。
- **FR-003**: Gem は郵便番号の先頭4桁以上を引数として受け取り、それに該当する住所候補の一覧を返せなければならない。
- **FR-004**: 先頭4桁未満の入力に対する候補検索は、空の結果を返さなければならない（過大結果の防止）。
- **FR-005**: Gem は郵便番号と住所文字列を受け取り、両者の整合性を boolean で返せなければならない。
- **FR-006**: Gem は Rails 7.x 以上で利用できる ActiveModel バリデーターを提供しなければならない。
- **FR-007**: バリデーターは郵便番号フィールドと住所フィールドを関連付けて整合性を自動チェックしなければならない。
- **FR-008**: 住所データは日本郵便が公開する郵便番号データ（KEN_ALL.CSV）を元に構築しなければならない。
- **FR-009**: 住所データの更新は、既存の使用には影響を与えずにデータファイルの差し替えで完結しなければならない。
- **FR-010**: Gem は Rails に依存しないコアロジックを持ち、Rack や Sinatra など Rails 以外の環境でも基本機能が利用できなければならない。
- **FR-011**: 検索結果の住所データは、少なくとも郵便番号・都道府県名・市区町村名・町域名の4フィールドを含まなければならない。
- **FR-012**: 不正な入力（nil、空文字、数字以外）に対してはエラーを発生させず、空の結果を返さなければならない。

### Key Entities

- **住所レコード (AddressRecord)**: 郵便番号・都道府県コード・都道府県名・市区町村名・町域名・読みがなを保持するデータ単位。郵便番号をキーに一意または複数存在しうる。
- **郵便番号データセット (PostalCodeDataset)**: KEN_ALL.CSV から構築された全住所レコードの集合。起動時にメモリに読み込まれ、検索に使用される。
- **住所バリデーター (AddressValidator)**: ActiveModel::Validator を継承し、モデルの郵便番号フィールドと住所フィールドの整合性を検証する Rails コンポーネント。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 郵便番号による住所検索の応答が、データ読み込み済みの状態で 10 ミリ秒以内に完了する（99パーセンタイル）。
- **SC-002**: 日本郵便の公式データに収録されている全郵便番号（約12万件）について、正しい住所が返る。
- **SC-003**: 先頭4桁による候補検索が 50 ミリ秒以内に完了する（候補件数に関わらず）。
- **SC-004**: Gem の起動・データ読み込みが 3 秒以内に完了し、Rails アプリの起動時間に大きな影響を与えない。
- **SC-005**: コード品質として自動テストカバレッジ 90% 以上を達成する。
- **SC-006**: 住所バリデーターを Rails モデルに組み込む手順が 3 行以内のコードで完結する。

### Constitution Compliance Criteria

> これらの基準は Constitution に基づく必須成功条件です。

- **CC-001**: `bundle exec rspec` が全テスト PASS し、SimpleCov カバレッジが **90% 以上**である。
- **CC-002**: `bundle exec rubocop` が PASS（警告・エラーゼロ、`rubocop:disable` コメントなし）。
- **CC-003**: すべての実装コードは先にテストを書き、Red-Green-Refactor サイクルを経ている（TDD）。
- **CC-004**: gem は `JpAddressComplement` 名前空間に閉じており、Rails 非依存のコアロジックを持つ。

## Assumptions

- 住所データのソースは日本郵便が無償で公開する KEN_ALL.CSV（全国版）とする。
- データ更新頻度については gem のバージョンアップ時にバンドルされたデータを更新する方式を基本とし、ユーザーが任意のタイミングで更新スクリプトを実行できる手段も提供する。
- 住所の文字コードは UTF-8 とする（KEN_ALL.CSV の Shift_JIS をビルド時に変換済みとする）。
- 全角数字の郵便番号は自動で半角に正規化して処理する（追加コストが小さいため）。
- 読みがなフィールドは返却データに含めるが、読みがなによる検索機能は本仕様のスコープ外とする。
- 大口事業所・私書箱向けの専用郵便番号も同一データに含め、同様に検索可能とする。
- Rails への依存は ActiveModel バリデーター提供部分のみに限定し、コア検索ロジックは Rack/Sinatra でも利用可能とする。
